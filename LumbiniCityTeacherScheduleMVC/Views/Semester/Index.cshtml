@model IEnumerable<LumbiniCityTeacherSchedule.Models.Models.Semester>

@{
    ViewData["Title"] = "Semesters List";
    var maxSemesterCount = 8;
    var currentSemesterCount = Model?.Count() ?? 0; // Use null-coalescing operator to safely count
    var programId = ViewContext.RouteData.Values["id"]?.ToString();
    var isDisabled = currentSemesterCount >= maxSemesterCount;
}

<div class="card shadow border-0 mt-4">
    <div class="card-header bg-secondary bg-gradient py-3">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="text-white py-2">Semesters List</h2>
            </div>
        </div>
    </div>
    <div class="card-body p-4">

        <!-- ViewBag Error with Better UI -->
        @if (ViewBag.Error != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @ViewBag.Error
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Create Semester Button -->
        <div class="row mb-3">
            <div class="col-12 text-end">
                @if (isDisabled)
                {
                    <a class="btn btn-primary disabled" aria-disabled="true" tabindex="-1">Create Semester</a>
                }
                else
                {
                    <a asp-action="Create" asp-route-id="@programId" class="btn btn-primary">Create Semester</a>
                }
            </div>
        </div>

        <!-- Semester Table -->
        @if (Model != null && Model.Any()) // Ensure Model is not null and contains data
        {
            <table class="table table-bordered">
                <thead>
                    <tr class="text-center">
                        <th style="width:5%">S.N</th>
                        <th style="width:40%">Semester</th>
                        <th style="width:55%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var sem in Model.Select((value, index) => new { value, index }))
                    {
                        <tr class="text-center">
                            <td>@(sem.index + 1)</td>
                            <td class="text-dark">
                                Semester: @sem.value.SemesterNumber
                            </td>
                            <td>
                                <a href="#" onclick="deleteSemester(@sem.value.SemesterId,this)" class="btn btn-danger btn-sm">Delete</a>
                                <a asp-controller="Configuration" asp-action="Index" asp-route-semesterId="@sem.value.SemesterId" asp-route-programId="@programId" class="btn btn-info btn-sm">Configuration</a>
                                <a asp-controller="Subject" asp-action="Index" asp-route-semesterId="@sem.value.SemesterId" asp-route-programId ="@programId" class="btn btn-primary btn-sm">Subject List</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info">No semesters available for this program.</div>
        }

        <!-- Back Button at the End -->
        <div class="row mb-3">
            <div class="col-12 text-start">
                <a asp-controller="Program" asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left-circle"></i> Back
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function deleteSemester(id,btn){
                 Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to undo this!.This will affect Subjects and Configuration",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                 }).then((result)=>{
                     if(result.isConfirmed){
                          $.ajax({
                                   url:"/Semester/Delete",
                                   type:"POST",
                                   data:{semesterId:id},
                                   success:function(response){
                                        if(response.success){
                                            toastr.success(response.message);
                                            $(btn).closest('tr').fadeOut(500, function()
                                            {
                                                $(this).remove();
                                            });
                                        }else
                                        {
                                            toastr.error(response.message);
                                        }

                                   },
                                   error: function()
                                   {
                                        toastr.error("Unexpected error occured");
                                   }
                          });
                      
                     }
                 });


        }

    </script>
}

